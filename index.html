<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Exosky!</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <style>
      body {
        background-color: #000;
        color: red;
        margin: 0;
        overflow: hidden;
      }

      a {
        color: white;
      }

      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-family: Arial, sans-serif;
      }
      #centerBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 10px 20px;
        background-color: #f00;
        color: white;
        border: none;
        font-family: Arial, sans-serif;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="info"></div>
    <div id="centerBtn">Центрировать камеру</div>

    <script type="importmap">
      {
        "imports": {
          "three": "../build/three.module.js",
          "three/addons/": "./jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { EXRLoader } from "three/addons/loaders/EXRLoader.js"; // EXRLoader для текстур

      let camera,
        controls,
        scene,
        renderer,
        raycaster,
        mouse,
        targetObject = null;

      // Загрузка данных из exoplanets.json
      fetch("exoplanets.json")
        .then((response) => response.json())
        .then((data) => {
          init(data);
        });

      function init(data) {
        // Создание сцены
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        // Загрузка текстуры фона
        new EXRLoader().load("./starmap.exr", function (texture) {
          texture.mapping = THREE.EquirectangularReflectionMapping;
          scene.background = texture;
          scene.environment = texture;
        });

        // Создание рендерера
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setAnimationLoop(animate);
        document.body.appendChild(renderer.domElement);

        // Создание камеры
        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          1,
          5000
        );
        camera.position.set(400, 200, 0);

        // Управление камерой
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.2;
        controls.minDistance = 10; // Минимальное расстояние до объектов
        controls.maxDistance = 10000; // Максимальное расстояние до объектов
        controls.maxPolarAngle = Math.PI / 2;

        // Добавление звёзд и планет
        addStars(data);
        addExoplanets(data);

        // Инициализация Raycaster для обработки кликов
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        document.addEventListener("click", onClick, false);

        // Добавление света
        const dirLight1 = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight1.position.set(1, 1, 1);
        scene.add(dirLight1);

        const ambientLight = new THREE.AmbientLight(0x555555);
        scene.add(ambientLight);

        window.addEventListener("resize", onWindowResize);

        document.getElementById("centerBtn").addEventListener("click", () => {
          camera.position.set(0, 0, 1000);
          controls.target.set(0, 0, 0);
          controls.update();
        });
      }

      // Добавление звёзд на основе данных из exoplanets.json
      function addStars(data) {
        data.forEach((star) => {
          if (star.ra && star.dec) {
            const raRad = THREE.MathUtils.degToRad(star.ra);
            const decRad = THREE.MathUtils.degToRad(star.dec);
            const distance = star.sy_dist ? star.sy_dist * 10 : 100;

            let x = distance * Math.cos(decRad) * Math.cos(raRad);
            let y = distance * Math.sin(decRad);
            let z = distance * Math.cos(decRad) * Math.sin(raRad);

            // Увеличение случайного сдвига объектов, чтобы они не сливались
            x += Math.random() * 75 - 37.5;
            y += Math.random() * 75 - 37.5;
            z += Math.random() * 75 - 37.5;

            // Создание сфер для звёзд
            const starGeometry = new THREE.SphereGeometry(5, 32, 32);
            const starMaterial = new THREE.MeshBasicMaterial({
              color: 0x708090,
            });
            const starSphere = new THREE.Mesh(starGeometry, starMaterial);
            starSphere.position.set(x, y, z);
            starSphere.userData = {
              name: star.sy_name,
              ra: star.ra,
              dec: star.dec,
              distance: star.sy_dist,
            };
            scene.add(starSphere);
          }
        });
      }

      // Добавление экзопланет
      function addExoplanets(data) {
        data.forEach((planet) => {
          if (planet.pl_name && planet.ra && planet.dec) {
            const raRad = THREE.MathUtils.degToRad(planet.ra);
            const decRad = THREE.MathUtils.degToRad(planet.dec);
            const distance = planet.sy_dist ? planet.sy_dist * 10 : 100;

            let x = distance * Math.cos(decRad) * Math.cos(raRad);
            let y = distance * Math.sin(decRad);
            let z = distance * Math.cos(decRad) * Math.sin(raRad);

            // Увеличение случайного сдвига объектов, чтобы они не сливались
            x += Math.random() * 75 - 37.5;
            y += Math.random() * 75 - 37.5;
            z += Math.random() * 75 - 37.5;

            // Увеличение размера планет, делим радиус на 5
            const planetGeometry = new THREE.SphereGeometry(
              planet.pl_rade / 5,
              32,
              32
            );
            const planetMaterial = new THREE.MeshBasicMaterial({
              color: 0x006400,
            });
            const planetSphere = new THREE.Mesh(planetGeometry, planetMaterial);
            planetSphere.position.set(x, y, z);
            planetSphere.userData = {
              name: planet.pl_name,
              ra: planet.ra,
              dec: planet.dec,
              distance: planet.sy_dist,
            };
            scene.add(planetSphere);
          }
        });
      }

      // Обработка кликов
      function onClick(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(scene.children);

        if (intersects.length > 0) {
          targetObject = intersects[0].object;
          if (targetObject.userData.name) {
            document.getElementById(
              "info"
            ).innerHTML = `Объект: ${targetObject.userData.name}<br>Координаты: RA=${targetObject.userData.ra}, Dec=${targetObject.userData.dec}<br>Расстояние: ${targetObject.userData.distance} парсек`;

            // Приближение к объекту
            const targetPos = new THREE.Vector3().copy(targetObject.position);
            controls.target.copy(targetPos); // Установка новой цели для камеры
            controls.update();
          }
        }
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        controls.update();
        render();
      }

      function render() {
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
